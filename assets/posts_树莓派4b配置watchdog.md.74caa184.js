import{_ as s,o as a,c as n,Q as o}from"./chunks/framework.b1192e57.js";const E=JSON.parse('{"title":"树莓派4b配置watchdog","description":"树莓派4b(ubuntu)配置watchdog防止系统卡死","frontmatter":{"title":"树莓派4b配置watchdog","description":"树莓派4b(ubuntu)配置watchdog防止系统卡死","date":"2023-12-08T00:00:00.000Z","tags":["linux","ubuntu"]},"headers":[],"relativePath":"posts/树莓派4b配置watchdog.md","filePath":"posts/树莓派4b配置watchdog.md","lastUpdated":1702879232000}'),p={name:"posts/树莓派4b配置watchdog.md"},l=o(`<p>在Linux系统中，Watchdog（看门狗）是一种硬件或软件机制，用于监视系统的运行状态，并在系统出现故障或停滞时采取预定的措施，例如重启系统。Watchdog 的目标是确保系统在发生故障时能够自动恢复，提高系统的可用性和稳定性。</p><p>Watchdog 的两种类型： 硬件 Watchdog：</p><p>硬件设备： 通常是一块专用的硬件电路，与计算机主板相连。 工作原理： Watchdog 定期向硬件设备发送信号，以表示系统正在正常运行。如果系统正常，那么 Watchdog 定期重置定时器。如果系统出现故障或停滞，Watchdog 定时器将超时，导致硬件设备采取预定的操作，例如重启系统。 使用： 多数服务器和嵌入式系统具有硬件 Watchdog。</p><p>软件 Watchdog：</p><p>软件实现： Watchdog 也可以是一个软件实现，通过在操作系统中运行特殊的 Watchdog 守护进程。 工作原理： 它通过周期性地向 Watchdog 守护进程发送信号，来表示系统正常运行。如果系统正常，Watchdog 守护进程定期重置定时器。如果系统停滞或发生故障，Watchdog 守护进程未能定期重置定时器，从而触发 Watchdog 机制采取措施，如重启系统。 使用： 适用于那些没有硬件 Watchdog 的系统。 Watchdog 在 Linux 中的使用： 安装 Watchdog：</p><p>在许多 Linux 发行版中，可以使用包管理工具来安装 watchdog：</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apt</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">watchdog</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;"># For Debian/Ubuntu</span></span>
<span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">yum</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">install</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">watchdog</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;"># For CentOS/RHEL</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apt</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">watchdog</span><span style="color:#24292E;">   </span><span style="color:#6A737D;"># For Debian/Ubuntu</span></span>
<span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">yum</span><span style="color:#24292E;"> </span><span style="color:#032F62;">install</span><span style="color:#24292E;"> </span><span style="color:#032F62;">watchdog</span><span style="color:#24292E;">       </span><span style="color:#6A737D;"># For CentOS/RHEL</span></span></code></pre></div><p>配置 Watchdog：</p><p>修改 /boot/config.txt 并重启使其生效</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># 在最后边增加一行配置项 </span></span>
<span class="line"><span style="color:#6A737D;"># echo &#39;dtparam=watchdog=on&#39; &gt;&gt; /boot/config.txt</span></span>
<span class="line"><span style="color:#E1E4E8;">dtparam</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">watchdog=on</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># 在最后边增加一行配置项 </span></span>
<span class="line"><span style="color:#6A737D;"># echo &#39;dtparam=watchdog=on&#39; &gt;&gt; /boot/config.txt</span></span>
<span class="line"><span style="color:#24292E;">dtparam</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">watchdog=on</span></span></code></pre></div><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">reboot</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">reboot</span></span></code></pre></div><p>配置文件通常是 /etc/watchdog.conf。您可以编辑此文件以更改 Watchdog 的配置，包括定时器超时时间、Watchdog 设备、启用或禁用软件 Watchdog 等。</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># /etc/watchdog.conf</span></span>
<span class="line"><span style="color:#6A737D;">#本机使用的树莓派4b，conf文件可以根据自己的需求定制</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># echo &#39;watchdog-device = /dev/watchdog&#39; &gt;&gt; /etc/watchdog.conf</span></span>
<span class="line"><span style="color:#6A737D;"># echo &#39;watchdog-timeout = 15&#39; &gt;&gt; /etc/watchdog.conf</span></span>
<span class="line"><span style="color:#6A737D;"># echo &#39;max-load-1 = 24&#39; &gt;&gt; /etc/watchdog.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">max-load-1</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">24</span></span>
<span class="line"><span style="color:#B392F0;">watchdog-device</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/dev/watchdog</span></span>
<span class="line"><span style="color:#B392F0;">watchdog-timeout</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">15</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># /etc/watchdog.conf</span></span>
<span class="line"><span style="color:#6A737D;">#本机使用的树莓派4b，conf文件可以根据自己的需求定制</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># echo &#39;watchdog-device = /dev/watchdog&#39; &gt;&gt; /etc/watchdog.conf</span></span>
<span class="line"><span style="color:#6A737D;"># echo &#39;watchdog-timeout = 15&#39; &gt;&gt; /etc/watchdog.conf</span></span>
<span class="line"><span style="color:#6A737D;"># echo &#39;max-load-1 = 24&#39; &gt;&gt; /etc/watchdog.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">max-load-1</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">24</span></span>
<span class="line"><span style="color:#6F42C1;">watchdog-device</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/dev/watchdog</span></span>
<span class="line"><span style="color:#6F42C1;">watchdog-timeout</span><span style="color:#24292E;"> </span><span style="color:#032F62;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">15</span></span></code></pre></div><p>启动看门狗服务</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">enable</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">watchdog</span></span>
<span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">watchdog</span></span>
<span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">systemctl</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">status</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">watchdog</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">enable</span><span style="color:#24292E;"> </span><span style="color:#032F62;">watchdog</span></span>
<span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">watchdog</span></span>
<span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">systemctl</span><span style="color:#24292E;"> </span><span style="color:#032F62;">status</span><span style="color:#24292E;"> </span><span style="color:#032F62;">watchdog</span></span></code></pre></div><p>模拟系统停滞或死锁，看看 Watchdog 是否能够在设定的时间内检测到问题并采取相应的措施。 使用无限递归函数炸弹(Infinite Recursive Function Bomb) 测试</p><div class="language-shell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">bash</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-c</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;:(){ :|:&amp; };:&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">bash</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-c</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;:(){ :|:&amp; };:&#39;</span></span></code></pre></div><p>Watchdog 的注意事项： Watchdog 需要谨慎使用，不当的配置可能导致系统不断重启。 Watchdog 的超时时间应根据系统特性和负载来调整，以确保能够检测到真正的问题。 在使用硬件 Watchdog 时，确保主板支持并已正确配置。 在使用 Watchdog 时，建议备份重要数据，以防 Watchdog 触发不断重启导致数据丢失。 总体而言，Watchdog 是一项有用的系统保护机制，特别适用于那些要求高可用性和可靠性的系统。</p><blockquote><p>参考文章: <a href="https://cmjava.ltd:8090/archives/shu-mei-pai-4b-an-zhuang-watchdog" target="_blank" rel="noreferrer">https://cmjava.ltd:8090/archives/shu-mei-pai-4b-an-zhuang-watchdog</a><a href="https://www.meowpass.com/pages/8a3f9b" target="_blank" rel="noreferrer">https://www.meowpass.com/pages/8a3f9b</a></p></blockquote>`,19),t=[l];function c(e,r,d,y,i,h){return a(),n("div",null,t)}const F=s(p,[["render",c]]);export{E as __pageData,F as default};
